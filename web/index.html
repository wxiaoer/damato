<!DOCTYPE html>
<html lang="en">

<head>
    <title>Damato</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
    <meta name="metro4:init" content="false">

    <!-- Metro 4 -->
    <link rel="stylesheet" href="css/metro-all.min.css">
    <style>
        html,
        body {
            height: 100%;
        }

        .blur {
            -webkit-filter: blur(5px);
            /* Chrome, Opera */
            -moz-filter: blur(5px);
            -ms-filter: blur(5px);
            filter: blur(5px);
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity .5s;
        }

        .fade-enter,
        .fade-leave-to {
            opacity: 0;
        }

        .slide-fade-enter-active {
            transition: all .2s ease;
        }

        .slide-fade-leave-active {
            transition: all .2s cubic-bezier(1.0, 0.5, 0.8, 1.0);
        }

        .slide-fade-enter {
            transform: translateY(10px);
            opacity: 0;
        }

        .slide-fade-leave-to {
            transform: translateY(-10px);
            opacity: 0;
        }
    </style>
</head>

<body>
    <div data-role="navview" data-expand="lg" data-compact="fs" data-active-state='true' id="app">
        <div class="navview-pane">
            <button class="pull-button">
                <span class="default-icon-menu"></span>
            </button>
            <ul class="navview-menu">
                <li @click="currentPage=0" :class="[currentPage==0?'active':'']">
                    <a>
                        <span class="icon"><span class="mif-home"></span></span>
                        <span class="caption">Damato</span>
                    </a>
                </li>
                <li @click="currentPage=1" :class="[currentPage==1?'active':'']">
                    <a>
                        <span class="icon"><span class="mif-chart-bars"></span></span>
                        <span class="caption">Chart</span>
                    </a>
                </li>
                <li @click="currentPage=2" :class="[currentPage==2?'active':'']">
                    <a>
                        <span class="icon"><span class="mif-cog"></span></span>
                        <span class="caption">Setting</span>
                    </a>
                </li>
                <li @click="currentPage=3" :class="[currentPage==3?'active':'']">
                    <a>
                        <span class="icon"><span class="mif-bug"></span></span>
                        <span class="caption">FeedBack</span>
                    </a>
                </li>
                <li @click="currentPage=4" :class="[currentPage==4?'active':'']">
                    <a>
                        <span class="icon"><span class="mif-info"></span></span>
                        <span class="caption">About</span>
                    </a>
                </li>
            </ul>
        </div>
        <div class="navview-content h-100">
            <transition name="slide-fade">
                <div class="h-100 w-100" v-show="currentPage == 0">
                    <!-- Task finished status -->
                    <div class="h-25 pt-5 pb-5" style="overflow-y: auto;">
                        <div class="flex-justify-center tiles-grid">
                            <div data-role="tile" class="bg-white">
                                <div
                                    class="slide d-flex flex-align-center flex-justify-center border bd-black fg-black">
                                    <span class="display3 fg-black">{{taskFinishedStatus.finishedCount}}</span>
                                    <span
                                        class="branding-bar d-flex flex-align-center flex-justify-center">Finished</span>
                                </div>
                            </div>
                            <div data-role="tile" class="bg-white">
                                <div
                                    class="slide d-flex flex-align-center flex-justify-center border bd-black fg-black">
                                    <span class="display3">{{taskFinishedStatus.unFinishedCount}}</span>
                                    <span
                                        class="branding-bar d-flex flex-align-center flex-justify-center fg-gray">Unfinished</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Task list -->
                    <div class="h-75 pb-20" style="overflow-y: auto;">
                        <ul class="custom-list">
                            <li class="p-2" v-for="task in tasks">
                                <div class="more-info-box bg-white fg-black">
                                    <div class="content c-pointer" @click="taskEdit(task)">
                                        <h4 class="text-bold mb-0">{{task.title}}</h4>
                                        <div>{{task.subTitle}}</div>
                                    </div>
                                    <div class="icon">
                                        <span class="mif-play c-pointer"
                                            @click="subTaskDo(taskNearestSubTask(task),task)"></span>
                                    </div>
                                    <a class="more bg-lightGray-hover" style="text-align:left;">
                                        <span class="mr-2" v-for="timeClassify of timeClassifys">
                                            <span v-for="subTask of task.subTasks">
                                                <span class="mif-alarm ani-heartbeat mif-2x ani-hover-shuttle c-pointer"
                                                    data-role="hint" data-cls-hint="bg-lightGray fg-black drop-shadow"
                                                    :data-hint-text="subTask.alarmTime"
                                                    v-if="subTask.timeClassify == timeClassify[0] && subTask.status=='' && taskNearestSubTask(task).id == subTask.id"
                                                    @click="subTaskDo(subTask,task)"></span>
                                                <span class="mif-alarm-on fg-orange mif-2x" data-role="hint"
                                                    data-cls-hint="bg-lightGray fg-black drop-shadow"
                                                    :data-hint-text="subTask.alarmTime"
                                                    v-else-if="subTask.timeClassify == timeClassify[0] && subTask.status=='finished'"></span>
                                                <span class="mif-alarm mif-2x ani-hover-shuttle c-pointer"
                                                    data-role="hint" data-cls-hint="bg-lightGray fg-black drop-shadow"
                                                    :data-hint-text="subTask.alarmTime"
                                                    v-else-if="subTask.timeClassify == timeClassify[0] && subTask.status==''"
                                                    @click="subTaskDo(subTask,task)"></span>
                                            </span>
                                        </span>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Quick options buttons -->
                    <div class="pos-absolute pos-bottom-center mb-5" style="z-index: 100;opacity: 0.9;" data-role="hint"
                        data-cls-hint="bg-lightGray fg-black drop-shadow"
                        :data-hint-text="allTaskNearestSubTask()[0].alarmTime" v-if="allTaskNearestSubTask()!=''"
                        @click="subTaskDo(allTaskNearestSubTask()[0],allTaskNearestSubTask()[1])" data-role="ripple"
                        data-ripple-target="button">
                        <button class="command-button px-5">
                            <span class="mif-play icon"></span>
                            <span class="caption">
                                {{allTaskNearestSubTask()[1].title}}
                                <small>{{allTaskNearestSubTask()[1].subTitle}}</small>
                            </span>
                        </button>
                    </div>
                    <div data-role="charms" data-opacity=".5" id="editTask_charm" data-position="right"
                        data-on-open="if(app.editTask.id==''){$(deleteTaskBtn).hide()}else{$(deleteTaskBtn).show()}"
                        class="w-100-sm w-75-lg px-20-sm px-10-lg bg-light fg-black">
                        <div class="grid">
                            <div class="row fg-black">
                                <h1 v-if="editTask.id==''">New task</h1>
                                <h1 v-else>Edit task</h1>
                            </div>
                            <div class="row fg-gray">
                                <div class="cell">
                                    <input type="text" data-role="materialinput" data-label="Title"
                                        data-cls-label="fg-black" placeholder="Enter title" v-model='editTask.title'>
                                </div>
                                <div class="cell">
                                    <input type="text" data-role="materialinput" data-label="Subtitle"
                                        data-cls-label="fg-black" placeholder="Enter subtitle"
                                        v-model='editTask.subTitle'>
                                </div>
                            </div>
                            <div class="row">
                                <div class="cell">
                                    <div class="fg-gray pt-4"><label>Task times</label></div>
                                    <input type="text" data-role="spinner" data-min-value="1"
                                        v-model="editTask.editTaskTimes"
                                        onchange="$(this)[0].dispatchEvent(new Event('input'));">
                                </div>
                                <div class="cell">
                                    <div class="fg-gray pt-4"><label>Task continue time</label></div>
                                    <input data-role="timepicker"
                                        onchange="$(this)[0].dispatchEvent(new Event('input'));"
                                        v-model="editTask.editTaskContinueTime">
                                </div>
                            </div>
                        </div>
                        <h3 class="fg-black">Subtasks detail</h3>
                        <div class="h-50 pb-15" style="overflow-y: auto;">
                            <div class="grid text-center">
                                <div class="row w-100">
                                    <div class="cell-1">
                                        Index
                                    </div>
                                    <div class="cell-5">
                                        Alarm time
                                    </div>
                                    <div class="cell-5">
                                        Task continue time
                                    </div>
                                    <div class="cell-1">
                                        Alarm?
                                    </div>
                                </div>
                                <div class="row w-100" v-for="(subTask,index) in editTask.subTasks">
                                    <div class="cell-1 pt-3">
                                        {{index+1}}
                                    </div>
                                    <div class="cell-5">
                                        <input data-role="timepicker" :data-value="0" v-model="subTask.alarmTime"
                                            onchange="$(this)[0].dispatchEvent(new Event('input'));"
                                            @change="classifyTime(subTask)">
                                    </div>
                                    <div class="cell-5">
                                        <input data-role="timepicker" :data-value="subTask.continueTime"
                                            v-model="subTask.continueTime"
                                            onchange="$(this)[0].dispatchEvent(new Event('input'));">
                                    </div>
                                    <div class="cell-1">
                                        <input type="checkbox" data-role="switch" data-caption=""
                                            v-model="subTask.weatherAlarm" data-material="true">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pos-absolute pos-bottom-right mb-5 mr-5" style="z-index: 1091;opacity: 0.9;">
                        <div class="multi-action">
                            <button class="action-button rotate-minus bg-gray fg-black" id="newTask_btn"
                                @click="toggleCharms()">
                                <span class="icon"><span class="mif-plus"></span></span>
                            </button>
                            <ul class="actions drop-left">
                                <li class="bg-lightGreen" @click="editTaskSave"><a><span class="mif-done"></span></a>
                                </li>
                                <li class="bg-lightRed" @click="taskDelete" id="deleteTaskBtn"><a><span
                                            class="mif-bin"></span></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </transition>
            <transition name="slide-fade">
                <div class="h-100 w-100" v-show="currentPage == 1" style="overflow-y: auto;">
                    <div class="card">
                        <div class="card-header">
                            Totle analyse
                        </div>
                        <div class="card-content p-2 h-30" style="position: relative;">
                            <canvas id="chart_all" width='1000' height='300'></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            {{detailAnalyseType}} analyse
                        </div>
                        <div class="card-content p-2 h-30" style="position: relative;">
                            <canvas id="chart_detail" width='1000' height='300'></canvas>
                        </div>
                    </div>
                </div>
            </transition>
            <transition name="slide-fade">
                <div class="h-100 w-100" v-show="currentPage == 2">
                    <div v-if="userInfo.userId == ''"
                        class="container d-flex flex-align-center flex-justify-center h-100">
                        <div v-if="signOrLog=='sign'" class="border bd-gray p-20" key='signPage'>
                            <div class="display1 text-center">Sign in</div>
                            <div>
                                <input type="text" data-role="materialinput" data-icon="<span class='mif-user'>"
                                    data-label="User name" placeholder="Enter your user name"
                                    v-model="userEditInfo.userName">
                            </div>
                            <div>
                                <input type="text" data-role="materialinput" data-icon="<span class='mif-envelop'>"
                                    data-label="User email" placeholder="Enter your email"
                                    v-model="userEditInfo.userEmail">
                            </div>
                            <div>
                                <input type="text" data-role="materialinput" data-icon="<span class='mif-phone'>"
                                    data-label="User phone number" placeholder="Enter your phone number"
                                    v-model="userEditInfo.userPhone"></div>
                            <div>
                                <input type="password" data-role="materialinput" data-icon="<span class='mif-lock'>"
                                    data-label="password" placeholder="Enter your password"
                                    v-model="userEditInfo.userOldPassw">
                            </div>
                            <div>
                                <input type="password" data-role="materialinput" data-icon="<span class='mif-lock'>"
                                    data-label="Re password" placeholder="Re enter your password"
                                    v-model="userEditInfo.userNewPassw">
                            </div>
                            <div class="pt-10 d-flex flex-justify-center">
                                <div data-role="buttongroup" class="button-group">
                                    <button class="button bg-lightBlue px-20" @click="userSignIn">Sign in</button>
                                </div>
                            </div>
                            <div class="pt-5 d-flex flex-justify-center">
                                <div data-role="buttongroup" class="button-group">
                                    <button class="button bg-lightGray px-20" @click="signOrLog='log'">Log in</button>
                                </div>
                            </div>
                        </div>
                        <div v-if="signOrLog=='log'" class="border bd-gray p-20" key='logPage'>
                            <div class="display1 text-center">Log in</div>
                            <div>
                                <input type="text" data-role="materialinput" data-icon="<span class='mif-envelop'>"
                                    data-label="User email" placeholder="Enter your email"
                                    v-model="userEditInfo.userEmail">
                            </div>
                            <div>
                                <input type="password" data-role="materialinput" data-icon="<span class='mif-lock'>"
                                    data-label="Password" placeholder="Enter your password"
                                    v-model="userEditInfo.userNewPassw">
                            </div>
                            <div class="pt-10 d-flex flex-justify-center">
                                <div data-role="buttongroup" class="button-group">
                                    <button class="button bg-lightBlue px-20" @click="userLogIn">Log in</button>
                                </div>
                            </div>
                            <div class="pt-5 d-flex flex-justify-center">
                                <div data-role="buttongroup" class="button-group">
                                    <button class="button bg-lightGray px-20" @click="signOrLog='sign'">Sign in</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else>
                        <div class="social-box" v-if="!userInfoEditTag">
                            <div class="header bg-cyan fg-white mt-0">
                                <img src="https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=317152053,3725599296&fm=26&gp=0.jpg"
                                    class="avatar">
                                <div class="title">{{userInfo.userName}}</div>
                                <div class="subtitle">{{userInfo.userTag}}</div>
                            </div>
                            <ul class="skills">
                                <li>
                                    <div class="text-bold">{{allAnalyseData.damatoCount}}</div>
                                    <div>Damato count</div>
                                </li>
                                <li>
                                    <div class="text-bold">{{allAnalyseData.damatoFinishCount}}</div>
                                    <div>Damato finish count</div>
                                </li>
                                <li>
                                    <div class="text-bold">{{allAnalyseData.damatoContinueCounte}}</div>
                                    <div>Damato continue count</div>
                                </li>
                            </ul>
                        </div>
                        <div class="container" v-if='userInfoEditTag'>
                            <div class="display1">Edit user info</div>
                            <div>
                                <input type="text" data-role="materialinput" data-icon="<span class='mif-user'>"
                                    data-label="User name" placeholder="Enter your user name"
                                    v-model="userEditInfo.userName">
                            </div>
                            <div>
                                <input type="text" data-role="materialinput" data-icon="<span class='mif-envelop'>"
                                    data-label="User email" placeholder="Enter your email"
                                    v-model="userEditInfo.userEmail">
                            </div>
                            <div>
                                <input type="text" data-role="materialinput" data-icon="<span class='mif-phone'>"
                                    data-label="User phone number" placeholder="Enter your phone number"
                                    v-model="userEditInfo.userPhone"></div>
                            <div>
                                <input type="password" data-role="materialinput" data-icon="<span class='mif-envelop'>"
                                    data-label="Old password" placeholder="Enter your old password"
                                    v-model="userEditInfo.userOldPassw">
                            </div>
                            <div>
                                <input type="password" data-role="materialinput" data-icon="<span class='mif-envelop'>"
                                    data-label="New password" placeholder="Enter your new password"
                                    v-model="userEditInfo.userNewPassw">
                            </div>
                            <div>
                                <input type="checkbox" data-role="switch" data-caption="Sync data to service"
                                    v-model="userEditInfo.userSync" data-material="true">
                            </div>
                            <div class="pt-10 d-flex flex-justify-center">
                                <div data-role="buttongroup" class="button-group">
                                    <button class="button bg-lightBlue px-10" @click="userInfoUpdate">Save</button>
                                    <button class="button bg-lightGray px-10"
                                        @click="userInfoEditTag=false">Cancel</button>
                                </div>
                            </div>
                        </div>
                        <div class="container" v-if="!userInfoEditTag">
                            <ul class="inline-list mt-5">
                                <li>Email:</li>
                                <li>{{userInfo.userEmail}}</li>
                            </ul>
                            <ul class="inline-list mt-5">
                                <li>Phone:</li>
                                <li>{{userInfo.userPhone}}</li>
                            </ul>

                            <div class="mt-5">
                                <input class="fg-gray" type="checkbox" data-role="checkbox"
                                    data-caption="Sync data to service" v-model="userEditInfo.userSync" disabled
                                    data-material="true">
                            </div>
                            <div class="pt-10 d-flex flex-justify-center">
                                <div data-role="buttongroup" class="button-group">
                                    <button class="button bg-lightBlue px-10"
                                        @click="userInfoEditTag=true">Edit</button>
                                    <button class="button bg-lightGray px-10" @click="userLogOut">Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
            <transition name="slide-fade ">
                <div class="h-100 w-100 container" v-show="currentPage == 3" style="overflow-y: auto;">
                    <div class="display1">Please tell me if you have any problems or suggestions when you using it</div>
                    <textarea class="h-40" data-role="textarea" v-model="feedBackText"
                        data-prepend="<span class='mif-leanpub'></span>"></textarea>
                    <div class="pt-2 d-flex flex-justify-end">
                        <div data-role="buttongroup" class="button-group">
                            <button class="button bg-lightGreen px-10" @click="feedBackSubmit">Submit</button>
                        </div>
                    </div>
                </div>
            </transition>
            <transition name="slide-fade ">
                <div class="h-100 w-100 " v-show="currentPage == 4"
                    style="overflow-y: auto;">
                        <div class="display1 text-center">About</div>
                        <div class="container d-flex flex-align-center h-75">
                            <div class="text-center w-100">
                                    <ul class="inline-list mt-5">
                                            <li>Software name:</li>
                                            <li>Damato</li>
                                        </ul>
                                        <ul class="inline-list mt-5">
                                            <li>Software version:</li>
                                            <li>0.1.0</li>
                                        </ul>
                                        <ul class="inline-list mt-5">
                                            <li>Author:</li>
                                            <li>WEX</li>
                                        </ul>
                                        <ul class="inline-list mt-5">
                                            <li>Author email:</li>
                                            <li><a href="">942208018@qq.com</a></li>
                                        </ul>
                                        <ul class="inline-list mt-5">
                                            <li>Author github:</li>
                                            <li><a href="">https://github.com/wxiaoer</a></li>
                                        </ul>
                            </div>
                        </div>
                </div>
            </transition>
        </div>
        <div id="countDownDiv" v-if="doSubTask!=''">
            <div class="pos-fixed pos-center global-dialog">
                <div class="row flex-justify-center">
                    <span class="display1 fg-white">{{doTask.title}}</span>
                </div>
                <div id="countDown" data-role="countdown" data-animate="slide" class="fg-white" data-days="0"
                    :data-hours="doSubTask.continueTime.split(':')[0]"
                    :data-minutes="doSubTask.continueTime.split(':')[1]"
                    :data-seconds="doSubTask.continueTime.split(':')[2]" data-on-alarm="app.taskFinish()"
                    data-on-countdown-create=""></div>
                <div class="row flex-justify-center mt-10">
                    <button class="button outline fg-white" onclick="app.doSubTask='';app.doTask='';">Cancel</button>
                </div>
            </div>
            <div class="overlay global-overlay bg-black fg-white" style="opacity: 0.8;"></div>
        </div>
    </div>

    <!-- Metro 4 -->
    <script src="js/metro.min.js"></script>
    <script src="js/vue.js"></script>
    <script src="js/Chart.min.js"></script>
    <script>
        var newSubTaskTemplate = { 'id': $.uniqueId(), 'alarmTime': '09:00:00', 'continueTime': '00:15:00', 'weatherAlarm': true, 'status': '', 'startTime': '', 'timeClassify': '' };
        var newTaskTemplate = { 'editTaskTimes': 1, 'editTaskContinueTime': '00:15:00', 'id': '', 'title': '', 'subTitle': '', 'subTasks': [newSubTaskTemplate] };
        var app = new Vue({
            el: '#app',
            data: {
                currentPage: 0,
                tasks: [],
                timeClassifys: [['morning', { 'start': '06:00:00', 'end': '09:00:00' }], ['foreNoon', { 'start': '09:00:00', 'end': '12:00:00' }], ['noon', { 'start': '12:00:00', 'end': '14:00:00' }], ['afterNoon', { 'start': '14:00:00', 'end': '19:00:00' }], ['night', { 'start': '19:00:00', 'end': '24:00:00' }], ['other', { 'start': '00:00:00', 'end': '06:00:00' }]],
                editTask: { 'editTaskTimes': 1, 'editTaskContinueTime': '00:15:00', 'id': '', 'title': '', 'subTitle': '', 'subTasks': [newSubTaskTemplate] },
                doTask: '',
                doSubTask: '',
                detailAnalyseType: 'Detail',
                userInfo: { 'userId': '', 'userName': '', 'userTag': '', 'userPhoto': '', 'userEmail': '', 'userPhone': '', 'userSync': true, 'userOldPassw': '', 'userNewPassw': '', 'logStatus': true, 'createTime': '' },
                userEditInfo: { 'userId': '', 'userName': '', 'userTag': '', 'userPhoto': '', 'userEmail': '', 'userPhone': '', 'userSync': true, 'userOldPassw': '', 'userNewPassw': '', 'logStatus': true, 'createTime': '' },
                userInfoEditTag: false,
                allAnalyseData: {},
                signOrLog: 'log',
                feedBackText:'',
            },
            computed: {
                taskFinishedStatus: function () {
                    var finishedCount = 0;
                    var unFinishedCount = 0;
                    for (task of this.tasks) {
                        for (subTask of task.subTasks) {
                            if (subTask.status == 'finished') {
                                finishedCount++;
                            } else {
                                unFinishedCount++;
                            }
                        }
                    }
                    return { 'finishedCount': finishedCount, 'unFinishedCount': unFinishedCount };
                },
                allSubTask: function () {
                    var allSubTask = new Array();
                    for (task of this.tasks) {
                        for (subTask of task.subTasks) {
                            allSubTask.push([task.title, subTask]);
                        }
                    }
                    return allSubTask;
                },
            },
            watch: {
                'editTask.editTaskTimes': {
                    deep: true,
                    handler: function (newVal) {
                        var currentSubTasksLength = this.editTask.subTasks.length;
                        if (currentSubTasksLength > newVal) {
                            for (var i = 0; i < currentSubTasksLength - newVal; i++) {
                                this.editTask.subTasks.pop();
                            }
                        } else if (currentSubTasksLength < newVal) {
                            for (var i = 0; i < newVal - currentSubTasksLength; i++) {
                                var newSubTask = JSON.parse(JSON.stringify(newSubTaskTemplate));
                                newSubTask.continueTime = this.editTask.editTaskContinueTime;
                                newSubTask.id = $.uniqueId();
                                this.classifyTime(newSubTask);
                                this.editTask.subTasks.push(newSubTask);
                            }
                        }
                    }
                },
            },
            created: function () {
                eel.tasksStatus()(initTasks);
                async function initTasks(result) {
                    if (result) {
                        await readTasks();
                        for (subTask of app.allSubTask) {
                            if (subTask[1].status == 'finished') {
                                var startDate = new Date(parseInt(subTask[1].startTime));
                                var currentDate = new Date();
                                var startFormatedTime = startDate.format("%d-%m-%Y");
                                var currentFormatedTime = currentDate.format("%d-%m-%Y");
                                // if (startDate.getFullYear() != currentDate.getFullYear() || startDate.getMonth() != currentDate.getMonth() || startDate.getDate() != currentDate.getDate()) {
                                if (startFormatedTime != currentFormatedTime) {
                                    await damatoArchive([startFormatedTime, app.tasks]);
                                    app.taskFinishLogClean();
                                }
                                break;
                            }
                        }
                    }
                }
                eel.analyseDataRead('allAnalyse', '')(initAllAnalyse);
                async function initAllAnalyse(result) {
                    app.allAnalyseData = result;
                    await initChart();
                }
                eel.readUserInfo()(initUserInfo);
                async function initUserInfo(result) {
                    if (result && result.logStatus) {
                        app.userInfo = result;
                        app.userEditInfo = JSON.parse(JSON.stringify(result));
                        app.userEditInfo.userOldPassw = '';
                        app.userEditInfo.userNewPassw = '';
                    }
                }
            },
            mounted: function () {
                Metro.init();
            },
            methods: {
                editTaskSave: function () {
                    if (!this.taskValidate()) {
                        Metro.toast.create("Please fill in title info.", null, 5000, "alert");
                        return false;
                    }
                    var editTask = JSON.parse(JSON.stringify(this.editTask));
                    if (editTask.id == '') {
                        editTask.id = $.uniqueId();
                        this.tasks.push(editTask);
                    } else {
                        for (var i = 0; i < this.tasks.length; i++) {
                            if (this.tasks[i].id == editTask.id) {
                                this.tasks[i] = editTask;
                                saveTasks()
                                break;
                            }
                        }
                    }
                    this.toggleCharms();
                },
                taskValidate: function () {
                    if (this.editTask.title == '' || this.editTask.subTitle == '') {
                        return false;
                    }
                    return true;
                },
                taskEdit: function (task) {
                    this.editTask = JSON.parse(JSON.stringify(task));
                    if (!$(newTask_btn).hasClass('active')) {
                        this.toggleCharms();
                    }
                },
                taskDelete: function (task) {
                    var tasks = this.tasks;
                    var editTask = this.editTask;
                    var toggleCharms = this.toggleCharms;
                    Metro.dialog.create({
                        title: "Delete this task",
                        content: "<div>This is a irrevocable option!</div>",
                        actions: [
                            {
                                caption: "Delete",
                                cls: "js-dialog-close alert",
                                onclick: function () {
                                    for (var i = 0; i < tasks.length; i++) {
                                        if (tasks[i].id == editTask.id) {
                                            tasks.splice(i, 1);
                                            // this.$forceUpdate();
                                            break;
                                        }
                                    }
                                    toggleCharms();
                                }
                            },
                            {
                                caption: "Cancel",
                                cls: "js-dialog-close",
                                onclick: function () {
                                    return true;
                                }
                            }
                        ]
                    });

                },
                toggleCharms: function () {
                    if ($(newTask_btn).hasClass('active')) {
                        this.editTask = JSON.parse(JSON.stringify(newTaskTemplate));
                        this.editTask.subTasks[0].id = $.uniqueId();
                        // console.log(this.editTask.subTasks[0].id);
                    }
                    $(newTask_btn).toggleClass('active');
                    $(editTask_charm).data('charms').toggle();
                },
                classifyTime: function (subTask) {
                    for (timeClassify of this.timeClassifys) {
                        if (subTask.alarmTime >= timeClassify[1].start && subTask.alarmTime < timeClassify[1].end) {
                            subTask.timeClassify = timeClassify[0];
                            break;
                        }
                    }
                },
                hasClassify: function (timeClassify, subTasks) {
                    for (subTask of subTasks) {
                        if (subTask.timeClassify == timeClassify) {
                            return true;
                        }
                    }
                    return false;
                },
                ta: function (obj) {
                    alert(JSON.stringify(obj));
                },
                taskNearestSubTask: function (task) {
                    var date = new Date();
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    var currentDate = year + '-' + month + '-' + day;
                    // var hours = date.getHours();
                    // var min = date.getMinutes();
                    // var second = date.getSeconds();
                    var currentTime = date.getTime();
                    var subTaskNearSet = [];
                    for (subTask of task.subTasks) {
                        if (subTask.status != 'finished') {
                            var taskAlarmDateStr = currentDate + ' ' + subTask.alarmTime;
                            var taskAlarmDate = new Date(taskAlarmDateStr);
                            var taskAlarmTime = taskAlarmDate.getTime();
                            // console.log(taskAlarmDateStr);
                            // console.log(date);
                            // console.log(taskAlarmTime);
                            // console.log(currentTime);
                            // console.log(Math.abs(taskAlarmTime - currentTime));
                            subTaskNearSet.push([subTask, Math.abs(taskAlarmTime - currentTime), subTask.alarmTime]);
                        }
                    }
                    subTaskNearSet.sort(function (a, b) { return a[1] - b[1] });
                    return subTaskNearSet[0][0];
                },
                allTaskNearestSubTask: function () {
                    if (this.tasks.length == 0) {
                        return '';
                    }
                    var date = new Date();
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    var currentDate = year + '-' + month + '-' + day;
                    // var hours = date.getHours();
                    // var min = date.getMinutes();
                    // var second = date.getSeconds();
                    var currentTime = date.getTime();
                    var subTaskNearSet = [];
                    for (task of this.tasks) {
                        for (subTask of task.subTasks) {
                            if (subTask.status != 'finished') {
                                var taskAlarmDateStr = currentDate + ' ' + subTask.alarmTime;
                                var taskAlarmDate = new Date(taskAlarmDateStr);
                                var taskAlarmTime = taskAlarmDate.getTime();
                                subTaskNearSet.push([subTask, Math.abs(taskAlarmTime - currentTime), subTask.alarmTime, task]);
                            }
                        }
                    }
                    subTaskNearSet.sort(function (a, b) { return a[1] - b[1] });
                    // console.log([subTaskNearSet[0][0],subTaskNearSet[0][3]]);
                    if (subTaskNearSet.length == 0) {
                        return '';
                    }
                    return [subTaskNearSet[0][0], subTaskNearSet[0][3]];
                },
                subTaskDo: function (subTask, task) {
                    // alert(JSON.stringify(subTask));
                    var now = new Date();
                    subTask.startTime = now.getTime();
                    this.doSubTask = subTask;
                    this.doTask = task;
                    // $('#countDownDiv').fadeIn();
                },
                taskFinish: function () {
                    // count down component will finished icorrectely
                    if ($('#countDown').data('countdown').getLeft().days == 0 && $('#countDown').data('countdown').getLeft().hours == 0 && $('#countDown').data('countdown').getLeft().minutes == 0 && $('#countDown').data('countdown').getLeft().seconds == 0) {
                        this.doSubTask.status = 'finished';
                        var notify = Metro.notify;
                        notify.setup({
                            width: 300,
                            duration: 1000,
                            animation: 'easeOutBounce'
                        });
                        notify.create(this.doTask.title + " finished!", "", { keepOpen: true });
                        notify.reset();
                        pushNotifier(this.doTask.title + " finished", this.doTask.subTitle, 'finished');
                        this.doSubTask = '';
                        this.doTask = '';
                    }
                    // this.doSubTask.status = 'finished';
                    // alert('finished');
                    // this.doSubTask = '';
                    // console.log('111');
                    // $('#countDownDiv').fadeOut();
                },
                taskFinishLogClean: function () {
                    for (subTask of this.allSubTask) {
                        subTask[1].status = '';
                        subTask[1].startTime = '';
                    }
                },
                userLogIn: function () {
                    eel.userLogIn(this.userEditInfo)(logIn);
                    function logIn(result) {
                        if (result) {
                            app.userInfo = result;
                            app.userEditInfo = JSON.parse(JSON.stringify(result));
                            app.userEditInfo.userNewPassw = '';
                            app.userEditInfo.userOldPassw = '';
                        } else {
                            alert('Log in failed');
                        }
                    }
                },
                userSignIn: function () {
                    if (this.userEditInfo.userNewPassw != this.userEditInfo.userOldPassw) {
                        Metro.toast.create("The two passwords do not match!", null, 3000, "alert");
                        return false;
                    }
                    this.userEditInfo.userId = $.uniqueId();
                    this.userEditInfo.createTime = new Date().getTime();
                    eel.userSignIn(this.userEditInfo)(signIn);
                    function signIn(result) {
                        if (result) {
                            app.userInfo = result;
                            app.userEditInfo = JSON.parse(JSON.stringify(result));
                            app.userEditInfo.userNewPassw = '';
                            app.userEditInfo.userOldPassw = '';
                        } else {
                            alert("Sign in failed");
                        }
                    }
                },
                userLogOut: function () {
                    this.userInfo.logStatus = false;
                    eel.userInfoSave(this._data.userInfo)();
                    this.userEditInfo.userNewPassw = '';
                    this.userEditInfo.userOldPassw = '';
                    this.userEditInfo.userId = '';
                    this.userInfo.userId = '';
                },
                userInfoUpdate: function () {
                    if (this.userEditInfo.userNewPassw == '' && this.userEditInfo.userOldPassw == '') {
                        this.userEditInfo.userNewPassw = this.userInfo.userNewPassw;
                        eel.userInfoSave(this.userEditInfo)(userInfoUpdated);
                        function userInfoUpdated(result) {
                            if (result) {
                                app.userInfo = result;
                                app.userEditInfo.userNewPassw = '';
                                app.userInfoEditTag = false;
                                Metro.toast.create("User info update success", null, 3000, "success");
                            }
                        }
                    } else if (this.userEditInfo.userOldPassw == this.userInfo.userNewPassw) {
                        eel.userInfoSave(this.userEditInfo)(userInfoUpdated);
                        function userInfoUpdated(result) {
                            if (result) {
                                app.userInfo = result;
                                app.userEditInfo.userNewPassw = '';
                                app.userEditInfo.userOldPassw = '';
                                app.userInfoEditTag = false;
                                Metro.toast.create("User info update success", null, 3000, "success");
                            }
                        }
                    } else {
                        Metro.toast.create("Password valide failed", null, 3000, "alert");
                    }
                },
                feedBackSubmit:function(){
                    if (this.feedBackText){
                        Metro.toast.create("Feedback success, thanks for your attation.",null,5000,"info");
                    }
                },
            }
        })
        async function initChart() {
            var ctw = document.getElementById('chart_all').getContext('2d');
            let dt = app.allAnalyseData;
            var dtv = [];
            var dtk = [];
            $.each(dt, function (k, v, i) { dtv.push(v) });
            $.each(dt, function (k, v, i) { dtk.push(k) });
            dtv.pop();
            dtk.pop();
            var allChart = new Chart(ctw, {
                type: 'bar',
                data: {
                    labels: dtk,
                    datasets: [{
                        label: 'Task count:',
                        data: dtv,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
            let dtd = await damatoFinishCountQuery('dayAnalyse', 5);
            dtdk = dtd[0];
            dtdv = dtd[1];
            var ctm = document.getElementById('chart_detail').getContext('2d');
            var detailChart = new Chart(ctm, {
                type: 'bar',
                data: {
                    labels: dtdk,
                    datasets: [{
                        label: 'Task count',
                        data: dtdv,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });

        };
        // save tasks
        async function saveTasks() {
            let result = await eel.saveTasks(app._data.tasks)();
            if (!result) {
                alert("Save task failed!");
            }
        }
        // read tasks
        async function readTasks() {
            let result = await eel.readTasks()();
            if (result) {
                app.tasks = result;
            } else {
                alert("Task read failed!");
            }
        }
        // archive damato
        async function damatoArchive(damato) {
            let result = await eel.damatoArchive(damato)();
            if (!result) {
                alert("archive damato failed!");
            }
        }
        // push notify
        async function pushNotifier(title, subtitle, type) {
            let result = await eel.pushNotifier(title, subtitle, type);
            if (!result) {
                alert('push notify failed');
            }
        }
        // analysed data query
        async function damatoFinishCountQuery(queryType, queryCount) {
            let dtd = await eel.analyseDataRead(queryType, queryCount)();
            var dtdv = [];
            var dtdk = [];
            $.each(dtd, function (k, v, i) { dtdv.push(v[1].damatoFinishCount) });
            $.each(dtd, function (k, v, i) { dtdk.push(v[0]) });
            dtdv.reverse();
            dtdk.reverse();
            return [dtdk, dtdv];
        }
        async function getAllAnalyseData() {
            let dt = await eel.analyseDataRead('allAnalyse', '')();
            return dt;
        }
        // window refresh option - save tasks
        window.onbeforeunload = function () {
            saveTasks();
        }
    </script>
</body>

</html>